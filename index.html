<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Ball Blast 2D</title>
  <style>
    html, body { margin:0; padding:0; background:#77d9ff; height:100%; overflow:hidden; touch-action:none; }
    #game { width:100vw; height:100vh; }
    .hud {
      position: fixed; left: 12px; top: 12px; z-index: 50;
      font: 800 13px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,.95);
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.25);
      padding: 10px 12px; border-radius: 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      pointer-events: none;
      white-space: pre;
    }
    .tip {
      position: fixed; left: 12px; bottom: 12px; z-index: 50;
      font: 700 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.22);
      padding: 10px 12px; border-radius: 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.16);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="hud" id="hud">Loading...</div>
  <div class="tip">Тяни палец — двигай пушку • Стрельба авто • Ульта справа снизу</div>
  <div id="game"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <script>
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

    class GameScene extends Phaser.Scene {
      constructor(){ super('game'); }

      create(){
        this.W = this.scale.width;
        this.H = this.scale.height;

        // Ground line
        this.groundY = this.H - 90;

        // progression / economy
        this.level = 1;
        this.stage = 1;              // можно позже сделать "этапы" по 10 уровней
        this.score = 0;
        this.coins = 0;
        this.best = Number(localStorage.getItem("bb_best")||0);

        // player stats (upgrades)
        this.hpMax = 3;
        this.hp = this.hpMax;
        this.dmg = 1;
        this.fireRate = 12;          // bullets per second
        this.bulletSpeed = 820;

        // ultimate
        this.ultCharge = 0;          // 0..1
        this.ultReady = false;
        this.ultName = "RAIN";

        // gameplay
        this.isPausedOverlay = false;
        this.lastShot = 0;

        // visuals: background (simple 2D)
        this.bg = this.add.graphics();
        this.drawBackground();

        // groups
        this.bullets = this.add.group();
        this.balls = this.add.group();
        this.coinsDrops = this.add.group();

        // cannon (2D, без 3D)
        this.cannon = this.add.container(this.W/2, this.groundY);
        const base = this.add.rectangle(0, 18, 80, 34, 0x2a2f3a, 1).setStrokeStyle(2, 0xffffff, 0.22);
        const wheelL = this.add.circle(-26, 26, 14, 0x1b1f28, 1).setStrokeStyle(2, 0xffffff, 0.18);
        const wheelR = this.add.circle( 26, 26, 14, 0x1b1f28, 1).setStrokeStyle(2, 0xffffff, 0.18);
        const barrel = this.add.rectangle(0, -6, 18, 52, 0xcfd6e4, 1).setStrokeStyle(2, 0x000000, 0.12);
        this.cannon.add([base, wheelL, wheelR, barrel]);

        // aim is always up; we move only X
        this.cannonMinX = 40;
        this.cannonMaxX = this.W - 40;

        // mobile control: drag anywhere
        this.dragging = false;
        this.input.on('pointerdown', (p)=>{
          if (this.isPausedOverlay) return;
          this.dragging = true;
          this.setCannonX(p.x);
          // if tap in ult zone, try ult
          if (this.isInUltZone(p.x, p.y)) this.tryUlt();
        });
        this.input.on('pointermove', (p)=>{
          if (this.isPausedOverlay) return;
          if (!this.dragging) return;
          this.setCannonX(p.x);
        });
        this.input.on('pointerup', ()=>{ this.dragging = false; });
        this.input.on('pointercancel', ()=>{ this.dragging = false; });

        // HUD
        this.hudEl = document.getElementById("hud");
        this.updateHud();

        // balls spawn
        this.waveSpawned = false;
        this.spawnLevel(this.level);

        // resize
        this.scale.on('resize', (gs)=>{
          this.W = gs.width; this.H = gs.height;
          this.groundY = this.H - 90;
          this.cannon.y = this.groundY;
          this.cannonMaxX = this.W - 40;
          this.drawBackground(true);
          this.updateHud();
        });
      }

      drawBackground(clear=false){
        if (clear) this.bg.clear();
        const g = this.bg;

        // sky
        g.fillStyle(0x77d9ff, 1);
        g.fillRect(0,0,this.W,this.H);

        // mountains (2D shapes)
        g.fillStyle(0x4bbbe6, 0.55);
        g.fillTriangle(40, this.H*0.65, this.W*0.35, this.H*0.18, this.W*0.62, this.H*0.65);
        g.fillTriangle(this.W*0.25, this.H*0.72, this.W*0.55, this.H*0.28, this.W*0.9, this.H*0.72);

        // ground
        g.fillStyle(0x70d65f, 1);
        g.fillRect(0, this.groundY+40, this.W, this.H-(this.groundY+40));

        // ground line
        g.lineStyle(3, 0x2a2f3a, 0.20);
        g.lineBetween(0, this.groundY+40, this.W, this.groundY+40);

        // ult hint ring
        g.fillStyle(0xffb100, 0.08);
        g.fillCircle(this.W - 70, this.H - 110, 52);
        g.lineStyle(3, 0xffb100, 0.18);
        g.strokeCircle(this.W - 70, this.H - 110, 52);
      }

      setCannonX(x){
        this.cannon.x = clamp(x, this.cannonMinX, this.cannonMaxX);
      }

      isInUltZone(x,y){
        // bottom-right area
        const cx = this.W - 70, cy = this.H - 110;
        return Math.hypot(x-cx, y-cy) <= 60;
      }

      updateHud(){
        const ultPct = Math.round(this.ultCharge*100);
        const ultText = this.ultReady ? `${this.ultName}: READY` : `${this.ultName}: ${ultPct}%`;
        this.hudEl.textContent =
          `LEVEL: ${this.level}  STAGE: ${this.stage}\n` +
          `SCORE: ${this.score}  BEST: ${this.best}\n` +
          `COINS: ${this.coins}\n` +
          `HP: ${this.hp}/${this.hpMax}  DMG:${this.dmg}  FR:${this.fireRate.toFixed(0)}\n` +
          `${ultText}`;
      }

      spawnLevel(lvl){
        this.waveSpawned = true;

        // clear old stuff (if any left)
        this.balls.getChildren().forEach(b=>b.destroy());
        this.coinsDrops.getChildren().forEach(c=>c.destroy());

        // spawn count and hp scaling
        const count = clamp(3 + Math.floor(lvl*0.35), 3, 10);
        const baseHP = 6 + Math.floor(lvl*1.2);

        for (let i=0;i<count;i++){
          const r = Phaser.Math.Between(22, 44);
          const x = Phaser.Math.Between(r+12, this.W - r - 12);
          const y = Phaser.Math.Between(120, 260);

          const b = this.add.circle(x, y, r, 0x2ecc71, 1);
          b.setStrokeStyle(4, 0xffffff, 0.25);

          // each ball has hp (number)
          b.hp = baseHP + Phaser.Math.Between(-4, 8);
          b.r = r;

          // simple physics (manual)
          b.vx = Phaser.Math.Between(-90, 90);
          b.vy = Phaser.Math.Between(-40, 40);

          // text label
          b.lbl = this.add.text(x, y, String(b.hp), {
            fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
            fontSize: `${Math.round(r*0.8)}px`,
            color:'#ffffff',
            fontStyle:'900'
          }).setOrigin(0.5);

          this.balls.add(b);
        }
      }

      shoot(time){
        const interval = 1000 / this.fireRate;
        if (time - this.lastShot < interval) return;
        this.lastShot = time;

        const b = this.add.circle(this.cannon.x, this.cannon.y - 52, 4, 0xffffff, 1);
        b.vy = -this.bulletSpeed;
        b.life = 1.4;
        this.bullets.add(b);

        // muzzle flash
        const f = this.add.circle(this.cannon.x, this.cannon.y - 60, 12, 0xffb100, 0.22);
        this.tweens.add({ targets:f, alpha:0, scale:1.4, duration:120, onComplete:()=>f.destroy() });
      }

      pop(x,y, color=0xffffff){
        const p = this.add.circle(x,y, 10, color, 0.18);
        p.setStrokeStyle(3, color, 0.22);
        this.tweens.add({ targets:p, alpha:0, scale:1.9, duration:180, onComplete:()=>p.destroy() });
      }

      dropCoins(x,y, amount){
        const n = clamp(Math.floor(amount/2), 1, 6);
        for (let i=0;i<n;i++){
          const c = this.add.circle(x, y, 7, 0xffd33d, 1);
          c.setStrokeStyle(2, 0xffffff, 0.25);
          c.vx = Phaser.Math.Between(-120,120);
          c.vy = Phaser.Math.Between(-280,-160);
          c.g = 720;
          c.life = 2.2;
          this.coinsDrops.add(c);
        }
      }

      tryUlt(){
        if (!this.ultReady || this.isPausedOverlay) return;

        this.ultReady = false;
        this.ultCharge = 0;

        // RAIN: 1 сек шквала пуль
        const dur = 1000;
        const shots = 34;
        const step = dur / shots;

        // эффект
        this.pop(this.cannon.x, this.cannon.y-60, 0xffb100);
        this.cameras.main.shake(90, 0.0045);
        if (navigator.vibrate) navigator.vibrate([20,25,20]);

        for (let i=0;i<shots;i++){
          this.time.delayedCall(i*step, ()=>{
            if (!this.scene.isActive()) return;
            const b = this.add.circle(this.cannon.x + Phaser.Math.Between(-10,10), this.cannon.y - 52, 4, 0xffb100, 1);
            b.vy = -this.bulletSpeed * 1.05;
            b.life = 1.2;
            b.ult = true;
            this.bullets.add(b);
          });
        }
      }

      openUpgradeAndChest(){
        this.isPausedOverlay = true;
        this.dragging = false;

        const overlay = this.add.rectangle(0,0,this.W,this.H, 0x000000, 0.35).setOrigin(0);

        const cw = Math.min(420, this.W - 40);
        const ch = 320;
        const cx = this.W/2 - cw/2;
        const cy = this.H/2 - ch/2;

        const card = this.add.graphics();
        card.fillStyle(0x0b2a55, 0.85);
        card.fillRoundedRect(cx,cy,cw,ch,18);
        card.lineStyle(3, 0xffffff, 0.16);
        card.strokeRoundedRect(cx,cy,cw,ch,18);

        const title = this.add.text(this.W/2, cy+22, `LEVEL ${this.level} CLEAR`, {
          fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
          fontSize:'18px',
          color:'#ffffff'
        }).setOrigin(0.5);

        // сундук (рандом награда)
        const chest = this.add.rectangle(this.W/2, cy+78, cw-40, 58, 0xffb100, 0.9)
          .setOrigin(0.5).setStrokeStyle(3, 0xffffff, 0.25);

        const chestText = this.add.text(this.W/2, cy+78, `CHEST: TAP TO OPEN`, {
          fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
          fontSize:'14px',
          color:'#3b2b00'
        }).setOrigin(0.5);

        let chestOpened = false;
        chest.setInteractive().on('pointerdown', ()=>{
          if (chestOpened) return;
          chestOpened = true;

          // reward types
          const roll = Phaser.Math.Between(1, 100);
          let msg = "";
          if (roll <= 55){
            const add = Phaser.Math.Between(20, 60);
            this.coins += add;
            msg = `+${add} COINS`;
          } else if (roll <= 80){
            this.dmg += 1;
            msg = `DMG +1`;
          } else {
            this.fireRate = Math.min(24, this.fireRate + 2);
            msg = `FIRE RATE +2`;
          }
          chestText.setText(`CHEST OPENED: ${msg}`);
          this.pop(this.W/2, cy+78, 0xffffff);
          this.updateHud();
        });

        const sub = this.add.text(this.W/2, cy+128, "CHOOSE UPGRADE", {
          fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
          fontSize:'14px',
          color:'#ffffff'
        }).setOrigin(0.5).setAlpha(0.9);

        const options = [
          { name:"+DMG", desc:"Damage +1", apply: ()=> this.dmg += 1 },
          { name:"+FIRE", desc:"FireRate +15%", apply: ()=> this.fireRate = Math.min(26, this.fireRate * 1.15) },
          { name:"+HP", desc:"MaxHP +1 (heal)", apply: ()=> { this.hpMax += 1; this.hp = this.hpMax; } },
        ];
        Phaser.Utils.Array.Shuffle(options);

        const btns = [];
        for (let i=0;i<3;i++){
          const o = options[i];
          const by = cy + 160 + i*52;
          const r = this.add.rectangle(this.W/2, by, cw-40, 44, 0x00c2ff, 0.25)
            .setOrigin(0.5).setStrokeStyle(2, 0xffffff, 0.16);

          const t1 = this.add.text(this.W/2 - (cw-40)/2 + 16, by-10, o.name, {
            fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
            fontSize:'14px',
            color:'#ffffff'
          }).setOrigin(0,0.5);

          const t2 = this.add.text(this.W/2 - (cw-40)/2 + 16, by+10, o.desc, {
            fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
            fontSize:'12px',
            color:'#d7f3ff'
          }).setOrigin(0,0.5).setAlpha(0.85);

          r.setInteractive().on('pointerdown', ()=>{
            o.apply();
            this.updateHud();

            // close overlay + next level
            [overlay, card, title, chest, chestText, sub, ...btns].forEach(x=>x.destroy());
            this.isPausedOverlay = false;

            // next level
            this.level++;
            if (this.level % 10 === 1 && this.level > 1) this.stage++;

            this.spawnLevel(this.level);
          });

          btns.push(r,t1,t2);
        }
      }

      update(time, dt){
        const delta = dt/1000;
        if (this.isPausedOverlay) return;

        // auto shooting
        this.shoot(time);

        // bullets
        this.bullets.getChildren().forEach(b=>{
          if (!b.active) return;
          b.y += (b.vy * delta);
          b.life -= delta;
          if (b.life <= 0 || b.y < -40){
            b.destroy();
          }
        });

        // balls movement + bounce + ground damage
        this.balls.getChildren().forEach(ball=>{
          if (!ball.active) return;

          ball.x += ball.vx * delta;
          ball.y += ball.vy * delta;

          // walls
          if (ball.x - ball.r < 0){ ball.x = ball.r; ball.vx *= -1; }
          if (ball.x + ball.r > this.W){ ball.x = this.W - ball.r; ball.vx *= -1; }

          // ceiling
          if (ball.y - ball.r < 80){ ball.y = 80 + ball.r; ball.vy *= -1; }

          // gravity feel (2D)
          ball.vy += 260 * delta;

          // ground hit => player damage
          if (ball.y + ball.r >= this.groundY + 34){
            ball.y = this.groundY + 34 - ball.r;
            ball.vy *= -0.78;

            // удар по игроку (простая механика)
            this.hp -= 1;
            this.cameras.main.shake(60, 0.0035);
            if (navigator.vibrate) navigator.vibrate(18);
            this.pop(ball.x, ball.y+ball.r, 0xff4d4d);

            if (this.hp <= 0){
              // game over overlay
              this.isPausedOverlay = true;
              const ov = this.add.rectangle(0,0,this.W,this.H,0x000000,0.4).setOrigin(0);
              const t = this.add.text(this.W/2, this.H/2-12, "GAME OVER", {
                fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
                fontSize:'28px', color:'#ffffff'
              }).setOrigin(0.5);
              const s = this.add.text(this.W/2, this.H/2+26, "Tap to restart", {
                fontFamily:'system-ui, -apple-system, Segoe UI, Roboto, Arial',
                fontSize:'14px', color:'#d7f3ff'
              }).setOrigin(0.5).setAlpha(0.9);

              this.best = Math.max(this.best, this.score);
              localStorage.setItem("bb_best", String(this.best));
              this.updateHud();

              this.input.once('pointerdown', ()=> location.reload());
            }
          }

          // sync label
          ball.lbl.x = ball.x;
          ball.lbl.y = ball.y;
          ball.lbl.setText(String(ball.hp));
        });

        // bullet vs ball collision
        this.bullets.getChildren().forEach(b=>{
          if (!b.active) return;
          let hit = null;

          this.balls.getChildren().forEach(ball=>{
            if (hit || !ball.active) return;
            const d = Math.hypot(b.x - ball.x, b.y - ball.y);
            if (d <= ball.r + 6) hit = ball;
          });

          if (hit){
            const dmg = this.dmg + (b.ult ? 1 : 0);
            hit.hp -= dmg;
            this.score += dmg;

            this.pop(b.x, b.y, b.ult ? 0xffb100 : 0xffffff);

            // bullets vanish
            b.destroy();

            if (hit.hp <= 0){
              // reward
              this.coins += 5 + Math.floor(this.level/2);
              this.ultCharge = clamp(this.ultCharge + 0.10, 0, 1);
              if (this.ultCharge >= 1) this.ultReady = true;

              this.dropCoins(hit.x, hit.y, 10 + this.level);
              hit.lbl.destroy();
              hit.destroy();
            }
          }
        });

        // coin drops update (collect if near cannon)
        this.coinsDrops.getChildren().forEach(c=>{
          if (!c.active) return;
          c.x += c.vx * delta;
          c.y += c.vy * delta;
          c.vy += c.g * delta;
          c.life -= delta;

          // bounce on ground
          const gy = this.groundY + 34;
          if (c.y >= gy){
            c.y = gy;
            c.vy *= -0.45;
            c.vx *= 0.85;
            if (Math.abs(c.vy) < 40) c.vy = 0;
          }

          // collect
          if (Math.hypot(c.x - this.cannon.x, c.y - (this.cannon.y+22)) < 44){
            this.coins += 1;
            c.destroy();
          }

          if (c.life <= 0) c.destroy();
        });

        // level clear -> upgrade & chest
        const alive = this.balls.getChildren().filter(x=>x.active).length;
        if (this.waveSpawned && alive === 0 && this.hp > 0){
          this.waveSpawned = false;
          this.best = Math.max(this.best, this.score);
          localStorage.setItem("bb_best", String(this.best));
          this.openUpgradeAndChest();
        }

        this.updateHud();
      }
    }

    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      width: window.innerWidth,
      height: window.innerHeight,
      backgroundColor: '#77d9ff',
      scene: [GameScene],
      scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH }
    };

    const game = new Phaser.Game(config);
    window.addEventListener('resize', ()=> game.scale.resize(window.innerWidth, window.innerHeight));
  </script>
</body>
</html>
